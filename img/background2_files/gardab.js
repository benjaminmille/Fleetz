/*
 * Copyright (c) 2013 by Marfeel Solutions (http://www.marfeel.com)
 * All Rights Reserved.
 *
 * NOTICE:  All information contained herein is, and remains
 * the property of Marfeel Solutions S.L and its suppliers,
 * if any.  The intellectual and technical concepts contained
 * herein are proprietary to Marfeel Solutions S.L and its
 * suppliers and are protected by trade secret or copyright law.
 * Dissemination of this information or reproduction of this material
 * is strictly forbidden unless prior written permission is obtained
 * from Marfeel Solutions SL.
 */

(function(e,t){function a(){return t!==t.top}function f(){var e=/.*(iPad|iPhone|iPod).*OS ([0-9])_([0-9]).*/g,t=e.exec(i.navigatorUserAgent);if(t){var n=t[1].toLowerCase();r={name:n,os:"ios",version:parseInt(t[2]),subversion:parseInt(t[3]),type:n==="ipad"?"l":"s"},r.browserHistory=r.version>4;if(r.version>=5||r.version===4&&r.subversion>=3)return!0}return!1}function l(){var e=/.*Android ([0-9])\.([0-9]).*; (.*) Build.* (Chrome|.+)\/.*? (Mobile|.+ )?/g,t=e.exec(i.navigatorUserAgent),n=i.windowWidth,s=i.windowHeight,o=n>s?"landscape":"portrait",u=o==="portrait"&&n<=635||o==="landscape"&&s<=635;if(t){r={name:t[3],os:"android",version:parseInt(t[1]),subversion:parseInt(t[2]),browser:t[4]=="Chrome"?"chrome":"aosp",type:t[5]?"s":u?"m":"l"},r.browserHistory=r.browser==="chrome";if(r.version>=4)return!0}return!1}function c(){var e=/.*BB10; ([\d\w]*)\).*Version\/(\d*)\.(\d*)\..*Mobile.*/g,t=e.exec(i.navigatorUserAgent);if(t){r={name:t[1],os:"bb10",version:parseInt(t[2]),subversion:parseInt(t[3]),type:"s"},r.browserHistory=!0;if(r.version===10&&r.subversion>=1)return!0}return!1}function h(){var e=/\bSilk\b/g;return e.test(i.navigatorUserAgent)?(r={name:"kindle",os:"kindle",type:"m"},r.browserHistory=!1,!0):!1}function p(){var n=t.innerWidth,r=e.createElement("div"),i=r.style,o=d(i);return r.className="mrf-marfeelBadge",i.position="fixed",i.display="block",i.bottom="25px",i.right=0,i.zIndex=99,i.backgroundImage="url("+v()+")",i.backgroundSize="100% 100%",i.webkitBorderTopLeftRadius="6px",i.webkitBorderBottomLeftRadius="6px",e.addEventListener("orientationchange",function(){n=t.innerWidth,d(i)}),e.addEventListener("touchend",function(){var e=t.innerWidth;n!=e&&(n=e,d(i))}),r.addEventListener("click",function(e){e.stopPropagation(),s.redirectToMarfeel("r=1")}),r}function d(e){var n,i,s=t.innerWidth/1024,o=Math.abs(t.orientation)===90?"landscape":"portrait";r.type==="s"?(i=o==="portrait"?270:240,n=i*.56):r.type==="m"?(i=o==="portrait"?160:100,n=i*.53):(i=o==="portrait"?140:100,n=i*.53),e.height=n*s+"px",e.width=i*s+"px"}function v(){return"http://"+i.marfeelHost+"/statics/marfeel/garda/mrf-badge-dflt."+r.type+".png"}function m(e,t){return e+=e.indexOf("?")>0?"&":"?",e+t}t.marfeel=t.marfeel||{};var n=4,r={},i,s,o=30,u=1378983741490;i=t.marfeel.GardaBUtil={locationSearch:t.location.search,locationPathname:t.location.pathname==="/"?"/index":t.location.pathname,navigatorUserAgent:t.navigator.userAgent,documentReferrer:e.referrer===""?"":"utm_referrer="+encodeURIComponent(e.referrer),documentDomain:e.domain,windowWidth:t.screen.width,windowHeight:t.screen.height,marfeelHost:t.mrfHost||"b.marfeel.com",supportedDeviceTypes:t.mrfDt||"lms",setCookieValue:function(t,n){var r=new Date,i=t+"="+n;r.setMinutes(r.getMinutes()+o),i+=";expires="+r.toGMTString(),i+=";domain="+this.documentDomain,i+=";path=/",e.cookie=i},getCookieValue:function(t){var n,r,i=e.cookie;t=t.trim(),i=i.split(";");for(n=0;n<i.length;n+=1){r=i[n],r=r.split("=");if(r[0].trim()===t)return r[1]}return null},getMarfeelUrl:function(e){var t="http://"+i.marfeelHost+"/"+i.documentDomain+i.locationPathname+i.locationSearch,n=i.documentReferrer==="";return r.browserHistory&&!n&&(t=m(t,i.documentReferrer)),e&&(t=m(t,e)),t},setLocation:function(e){t.location.href=e}},s=t.marfeel.GardaB={captureOriginalDocument:!1,getDevice:function(){return r},isEnabled:function(){return i.locationSearch.indexOf("marfeelgarda=off")===-1},isDeviceSupported:function(){var e=f()||h()||l()||c(),t=e&&i.supportedDeviceTypes.indexOf(r.type)>=0;return!this.isEnabled()||e&&t},comesFromMarfeel:function(){var e=i.locationSearch.indexOf("fromt=yes")>-1||i.getCookieValue("FromMarfeel")==="YES"||i.getCookieValue("FromMarfeelOnError")==="YES";return i.setCookieValue("FromMarfeel","NO"),e},userWantsMarfeel:function(){var e=parseInt(i.getCookieValue("MarfeelCreation"))>u;return e?i.getCookieValue("MarfeelGarda")!=="NO":!0},fallbackToClassicVersion:function(t){i.setLocation(m(t||e.location.href,"fromt=yes"))},redirectToMarfeel:function(t){var r=i.getMarfeelUrl(t),o=new XMLHttpRequest,u;o.open("GET",r),o.timeout=1e4,o.ontimeout=function(){s.fallbackToClassicVersion()},o.onreadystatechange=function(){o.readyState===n&&(o.status>0&&o.status<400?(u=e.open("text/html","replace"),u.write(o.responseText),u.close()):s.fallbackToClassicVersion())},o.send()},showMarfeelBadge:function(){var n=function(){t.removeEventListener("DOMContentLoaded",n),t===t.top&&e.getElementsByTagName("body")[0].appendChild(p())};e.readyState==="interactive"||e.readyState==="complete"?t===t.top&&e.getElementsByTagName("body")[0].appendChild(p()):t.addEventListener("DOMContentLoaded",n)},perform:function(){!a()&&this.isDeviceSupported()&&(!this.comesFromMarfeel()&&this.userWantsMarfeel()?((i.documentDomain.indexOf("www.capital.fr")===-1||i.documentDomain.indexOf("www.nationalgeographic.fr")===-1||i.documentDomain.indexOf("www.geo.fr")===-1)&&e.write('<plaintext style="display:none">'),!this.captureOriginalDocument||e.readyState==="interactive"||e.readyState==="complete"?this.redirectToMarfeel():this.captureOriginalDocument&&t.addEventListener("DOMContentLoaded",function(){s.redirectToMarfeel()})):this.isEnabled()&&this.showMarfeelBadge())}},s.perform()})(document,window);